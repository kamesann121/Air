<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新しくタブ</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/lobby.css">
</head>
<body>
  <div class="lobby-container">
    <!-- ヘッダー -->
    <header class="lobby-header">
      <div class="header-left">
        <h1>3D Air Hockey</h1>
        <div id="latency-display" class="latency">--ms</div>
      </div>
      <div class="header-right">
        <button id="profile-btn" class="btn btn-secondary">
          <span class="icon">👤</span> プロフィール
        </button>
        <button id="logout-btn" class="btn btn-danger">ログアウト</button>
      </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="lobby-main">
      <!-- 左サイドバー: パーティー情報 -->
      <aside class="sidebar sidebar-left">
        <div class="section">
          <div class="section-header">
            <h2>パーティー</h2>
            <button id="create-party-btn" class="btn btn-sm btn-primary">作成</button>
          </div>
          
          <div id="party-info" class="party-info">
            <p class="no-party">パーティーに参加していません</p>
          </div>
          
          <div class="party-actions">
            <button id="ready-btn" class="btn btn-primary hidden">準備完了</button>
            <button id="leave-party-btn" class="btn btn-danger hidden">退出</button>
          </div>
        </div>
      </aside>

      <!-- 中央: マッチメイキング -->
      <section class="main-content">
        <div class="matchmaking-section">
          <h2>マッチメイキング</h2>
          
          <div class="matchmaking-card">
            <div class="card-icon">🎮</div>
            <h3>ソロマッチ</h3>
            <p>1対1のランダムマッチ</p>
            <button id="solo-queue-btn" class="btn btn-lg btn-primary">ソロマッチ</button>
          </div>
          
          <div class="matchmaking-card">
            <div class="card-icon">👥</div>
            <h3>パーティーマッチ</h3>
            <p>フレンドと一緒に利用</p>
            <p class="card-hint">パーティーを作成してフレンドを招待しよう</p>
          </div>
        </div>

        <!-- 統計情報 -->
        <div class="stats-section">
          <h2>あなたの統計</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="wins-stat">0</div>
              <div class="stat-label">勝利</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="losses-stat">0</div>
              <div class="stat-label">敗北</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="winrate-stat">0%</div>
              <div class="stat-label">勝率</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 右サイドバー: フレンドリスト -->
      <aside class="sidebar sidebar-right">
        <div class="section">
          <div class="section-header">
            <h2>フレンド</h2>
            <button id="add-friend-btn" class="btn btn-sm btn-primary">追加</button>
          </div>
          
          <div id="friends-list" class="friends-list">
            <p class="loading">読み込み中...</p>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Socket.IO クライアント -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- カスタムスクリプト -->
  <script src="/js/socket-client.js"></script>
  <script src="/js/lobby.js"></script>
  <script>
    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', async () => {
      // 認証チェック
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');
      
      if (!token || !userId) {
        window.location.href = '/login.html';
        return;
      }
      
      try {
        // Socket.IO接続
        const socketClient = new SocketClient();
        const socket = await socketClient.connect();
        
        // ロビーマネージャー初期化
        const lobbyManager = new LobbyManager(socket);
        
        // ユーザー統計を取得して表示
        fetchUserStats();
        
        // ログアウトボタン
        document.getElementById('logout-btn').addEventListener('click', () => {
          if (confirm('ログアウトしますか？')) {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            socketClient.disconnect();
            window.location.href = '/login.html';
          }
        });
        
      } catch (error) {
        console.error('初期化エラー:', error);
        alert('接続に失敗しました。ページを再読み込みしてください。');
      }
    });
    
    // ユーザー統計を取得
    async function fetchUserStats() {
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');
      
      try {
        const response = await fetch(`/api/users/${userId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          displayUserStats(user.stats);
        }
      } catch (error) {
        console.error('統計取得エラー:', error);
      }
    }
    
    // 統計を表示
    function displayUserStats(stats) {
      document.getElementById('wins-stat').textContent = stats.wins || 0;
      document.getElementById('losses-stat').textContent = stats.losses || 0;
      
      const totalGames = stats.wins + stats.losses;
      const winRate = totalGames > 0 
        ? Math.round((stats.wins / totalGames) * 100) 
        : 0;
      
      document.getElementById('winrate-stat').textContent = `${winRate}%`;
    }
  </script>
</body>
</html>
