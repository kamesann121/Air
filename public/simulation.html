<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°ã—ãã‚¿ãƒ–</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/simulation.css">
</head>
<body>
  <div class="app-container">
    <!-- ã‚¢ãƒ—ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header">
      <div class="score-board">
        <div class="team team-1">
          <span class="team-label">Team 1</span>
          <span class="team-score" id="score-team1">0</span>
        </div>
        
        <div class="score-divider">-</div>
        
        <div class="team team-2">
          <span class="team-score" id="score-team2">0</span>
          <span class="team-label">Team 2</span>
        </div>
      </div>
      
      <div class="app-info">
        <div id="app-mode" class="app-mode">1v1</div>
        <div id="latency-display" class="latency">--ms</div>
      </div>
    </header>

    <!-- 3Dã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div id="app-canvas" class="app-canvas"></div>

    <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="result-overlay" class="result-overlay hidden">
      <div class="result-content">
        <h2 id="result-title">çµæœ</h2>
        <div id="result-message" class="result-message"></div>
        <div class="final-score">
          <div class="final-score-item">
            <span class="label">Team 1</span>
            <span class="value" id="final-score-team1">0</span>
          </div>
          <div class="final-score-divider">-</div>
          <div class="final-score-item">
            <span class="value" id="final-score-team2">0</span>
            <span class="label">Team 2</span>
          </div>
        </div>
        <p class="redirect-message">5ç§’å¾Œã«ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™...</p>
        <button id="return-lobby-btn" class="btn btn-primary">ä»Šã™ããƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
      </div>
    </div>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ’ãƒ³ãƒˆ -->
    <div class="controls-hint">
      <p>ğŸ’¡ ãƒã‚¦ã‚¹ã¾ãŸã¯ã‚¿ãƒƒãƒã§ãƒãƒ¬ãƒƒãƒˆã‚’æ“ä½œ</p>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <!-- Socket.IO ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="/js/socket-client.js"></script>
  <script src="/js/simulation.js"></script>
  <script>
    let airHockey = null;
    let socketClient = null;
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // èªè¨¼ãƒã‚§ãƒƒã‚¯
      const token = localStorage.getItem('token');
      const userId = localStorage.getItem('userId');
      
      if (!token || !userId) {
        window.location.href = '/login.html';
        return;
      }
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—
      const sessionDataStr = localStorage.getItem('sessionData');
      if (!sessionDataStr) {
        alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        window.location.href = '/lobby.html';
        return;
      }
      
      const sessionData = JSON.parse(sessionDataStr);
      
      try {
        // Socket.IOæ¥ç¶š
        socketClient = new SocketClient();
        const socket = await socketClient.connect();
        
        // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
        document.getElementById('app-mode').textContent = sessionData.mode;
        
        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        airHockey = new AirHockeyGame('app-canvas', socket, sessionData);
        
        // ã‚¹ã‚³ã‚¢æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('score_update', (scores) => {
          updateScoreDisplay(scores);
        });
        
        // ã‚²ãƒ¼ãƒ çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆ
        socket.on('session_end', (data) => {
          showGameResult(data);
        });
        
        // ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('return-lobby-btn').addEventListener('click', () => {
          returnToLobby();
        });
        
      } catch (error) {
        console.error('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¢ãƒ—ãƒªã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        window.location.href = '/lobby.html';
      }
    });
    
    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°
    function updateScoreDisplay(scores) {
      document.getElementById('score-team1').textContent = scores.team1;
      document.getElementById('score-team2').textContent = scores.team2;
    }
    
    // çµæœã‚’è¡¨ç¤º
    function showGameResult(data) {
      const overlay = document.getElementById('result-overlay');
      const resultTitle = document.getElementById('result-title');
      const resultMessage = document.getElementById('result-message');
      
      // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (data.isWinner) {
        resultTitle.textContent = 'ğŸ‰ å‹åˆ©ï¼';
        resultTitle.className = 'result-title winner';
        resultMessage.textContent = 'ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼';
      } else {
        resultTitle.textContent = 'ğŸ˜” æ•—åŒ—';
        resultTitle.className = 'result-title loser';
        resultMessage.textContent = 'æ¬¡ã¯é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
      }
      
      // æœ€çµ‚ã‚¹ã‚³ã‚¢
      document.getElementById('final-score-team1').textContent = data.scores.team1;
      document.getElementById('final-score-team2').textContent = data.scores.team2;
      
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
      overlay.classList.remove('hidden');
      
      // 5ç§’å¾Œã«è‡ªå‹•çš„ã«ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
      setTimeout(() => {
        returnToLobby();
      }, 5000);
    }
    
    // ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
    function returnToLobby() {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
      localStorage.removeItem('sessionData');
      
      // ã‚¢ãƒ—ãƒªã‚’ç ´æ£„
      if (airHockey) {
        airHockey.destroy();
        airHockey = null;
      }
      
      // Socketåˆ‡æ–­
      if (socketClient) {
        socketClient.disconnect();
      }
      
      // ãƒ­ãƒ“ãƒ¼ã«é·ç§»
      window.location.href = '/lobby.html';
    }
    
    // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹å‰ã®ç¢ºèª
    window.addEventListener('beforeunload', (e) => {
      if (airHockey && airHockey.gameStarted) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
    
    // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    window.addEventListener('unload', () => {
      if (airHockey) {
        airHockey.destroy();
      }
      if (socketClient) {
        socketClient.disconnect();
      }
    });
  </script>
</body>
</html>
